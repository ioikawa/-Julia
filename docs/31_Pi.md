# 無限級数の数値計算

## 無限級数
実数列$\{a_n\}$の級数
```math
  \sum_{k=1}^\infty a_n
```
はある実数 $S$ に収束するとする．第 $n$ 項までの部分和を
```math
  S_n := \sum_{k=1}^n a_n
```
とおくと，$S = \lim_{n \to \infty} S_n$ と表されるので，
（大きな）正の整数 $n$ に対して $S_n$ は $S$ の近似値になると期待される．

## 円周率 `pi`
Juliaでは，円周率は数学定数として実装してある．
```@repl
pi           # 遅延評価．実際に計算されるときに適切な形で実体化される．
Float64(pi)    # `Float64` 型として実体化
```
後者の16桁の値は一致しているので，この節では円周率の正確な値として参照してよい．
念のため，円周率を16桁まで書き出しておく．
```
 3.14159_26535_89793
```
ここでは円周率を無限級数で表し，近似値の計算方法について述べる．


## Leibniz（ライプニッツ）の公式
以下の交代級数に関する公式
```math
 1 - \dfrac{1}{3} + \dfrac{1}{5} - \dfrac{1}{7} + \cdots = \dfrac{\pi}{4}
```
をLeibnizの公式と呼ぶ．これは収束が遅いので，円周率の近似値計算には適さないが，試しに計算してみよう．

```@repl
leibniz(n) = 4*sum((-1)^i/(2i+1) for i in 0:n)
#function leibniz(n)
#   s = 0.0
#   for i in 0:n
#       s += (-1)^i/(2i+1)
#   end
#   return 4s
#end
leibniz(120)
```
120+1項まで計算してやっと3桁まで一致する程度であり，やはり収束速度は非常に遅い．

!!! note
    内包表記と`sum`により和を計算する場合は`[...]`で囲わないほうが効率が良い．
    例えば，`sum([i for i in 1:10])` は`sum(i for i in 1:10)`と書いたほうよい．
    どちらも同じ値を返すが，前者はカッコ内コード `[i for i in 1:10]` が新たな配列を生成するため，余計なアロケーションを発生させる．
    

## Machin（マチン）の公式: [MathWorld](https://mathworld.wolfram.com/MachinsFormula.html)
Machinの公式
```math
   4\arctan \dfrac{1}{5} - \arctan \dfrac{1}{239} = \dfrac{\pi}{4}.
```
を用いた円周率の近似値計算は収束が速く，より実用的である．
$\arctan x$ の原点におけるTaylor展開
```math
 \arctan x = x - \dfrac{x^3}{3} + \dfrac{x^5}{5} - \dfrac{x^7}{7} + \cdots
```
は $|x| \le 1$ で収束する．
この級数に$x=1/5, 1/239$を代入すると，次の級数展開を得る．
```math
\pi = 16\sum_{i=0}^\infty \frac{(-1)^i}{2i+1} 5^{-(2i+1)}
  - 4\sum_{i=0}^\infty \frac{(-1)^i}{2i+1} 239^{-(2i+1)}
```
これを適当な項数で打ち切れば円周率の近似を与える．
!!! note 
    Machinの公式で円周率の近似値を計算するプログラムを自分で作成してみよう．
    ```
      abs(近似値 -  Float64(pi)) < 1e-15
    ```
    が `true` になれば `Float64`型に関しては限界近くまで近似できていると判断してください．



## Appendex: `BigFloat`型で円周率を表示する
任意精度の浮動小数点数を扱うものとして，Juliaでは `BigFloat` 型が用意してある．
`BigFloat`型で `pi` を実体化すれば任意の桁数で 円周率を表示できる．
```@repl
setprecision(2600)   # 精度を 2600 bits に設定．
big(pi)
```
2600 bits は 10進数に換算すると，およそ782桁 ($2600 \log_{10} 2 \approx 782.7$)
に相当する．
出力を5桁ごとに区切って整形すると次のようになる．
```
3.
14159 26535 89793 23846 26433 83279 50288 41971 69399 37510   
58209 74944 59230 78164 06286 20899 86280 34825 34211 70679
82148 08651 32823 06647 09384 46095 50582 23172 53594 08128    
48111 74502 84102 70193 85211 05559 64462 29489 54930 38196 
44288 10975 66593 34461 28475 64823 37867 83165 27120 19091
45648 56692 34603 48610 45432 66482 13393 60726 02491 41273
72458 70066 06315 58817 48815 20920 96282 92540 91715 36436 
78925 90360 01133 05305 48820 46652 13841 46951 94151 16094 
33057 27036 57595 91953 09218 61173 81932 61179 31051 18548
07446 23799 62749 56735 18857 52724 89122 79381 83011 94912
98336 73362 44065 66430 86021 39494 63952 24737 19070 21798
60943 70277 05392 17176 29317 67523 84674 81846 76694 05132 
00056 81271 45263 56082 77857 71342 75778 96091 73637 17872 
14684 40901 22495 34301 46549 58537 10507 92279 68925 89235
42019 95611 21290 21960 86403 44181 59813 62977 47713 09960
51870 72113 49999 99837 29780 49951 056
```

