# 浮動小数点数

計算機において小数は**浮動小数点数 (Floating Point Number)**として実装されている．

例えば，$10$ 進数の浮動小数点数は
$$ 1.234 \times 10^8 $$
という形で表されるような数である．ただし，仮数部$(1.234)$の桁数は固定で，指数の範囲も有界である．

実際には`Inf` （無限大） や `NaN` (Not a Number) が付け加わる．

浮動小数点数の標準規格はIEEE754で策定されている．


計算機における浮動小数点数とその演算は，数学の実数とは異なるものであることは念頭に入れておく必要がある．

## 単精度と倍精度

多くのハードウェアやプログラミング言語で実装されている浮動小数点数は
  - 倍精度 (double precision) 
  - 単精度 (single precision) 

の２種類である．

Juliaでは `Float64`が倍精度，`Float32`が単精度，に対応している
  
変数に小数を代入すると，暗黙のうちに `Float64` と解釈される．
```@repl
x = 0.1
typeof(x)
```

特別な理由がない限り，普通は倍精度 `Float64` を用いる．

## 指数表記
浮動小数点数は次のように `e` あるいは `E` の記号の後ろに指数を表記する．
```@repl
0.0000012345
```
`1.2345e-6` は $ 1.234 \times 10^{-6} $ に等しい．

`1.0e8` あるいは `1.0e+8` は $10^{8}$の浮動小数点数を表す．

`1e8` や `1e+8` と書いても同じことである．整数型にはならないことに注意．

## 丸め誤差
浮動小数点数どうしを四則演算して得られた値は浮動小数点数になるとは限らない．


```@repl
1.111111111^2   
```

正確な値は $1.111111111^2 = 1.234567900987654321$ であり，この場合は下4桁分が切り捨てられている．

このように演算結果の値に近い浮動小数点数への近似を **丸め** (rounding) といい，

その際に生じる誤差を **丸め誤差** (rounding error)  という．

丸め誤差は浮動小数点数の計算において，ほぼ必然的に発生する．

丸め方には，正/負の無限大の方向，原点方向，最近点への丸めなどがある．

## オーバーフロー
倍精度で扱える最大の正の数は`floatmax`で取得できる．

浮動小数点数の演算の結果，この`x_max`を超えた場合，無限大を表す `Inf` となる．
このような現象を overflow という．

```@repl
x_max = floatmax(Float64)
2 * x_max 
```

浮動小数点数には先頭桁が`0`の非正規数も実装されている．

最小の正の非正規数は `eps(0.0)` で取得できる．演算結果がこれを下回ると `0.0` に丸められることがあり，これを underflow という．

```@repl
subnormal_min = eps(0.0)
subnormal_min/2  
```

## `NaN` (Not a Number)

浮動小数点数において不正な演算を行った結果，`NaN` という記号（正確には特別な浮動小数点数のひとつ）が発生することがある．

例えば，0を0で割ると `Nan` が発生する．
```
0/0
```

ちなみに0以外の正の浮動小数点数をゼロで割ると`Inf`になる．
```
1/0
```

!!! note
    Python3ではゼロ除算は `ZeroDivisionError`というエラーを返し，`NaN`にはなりません．
    処理系によっては動作がまちまちなので注意．

これ以外にも，`Inf`に関する四則演算の結果，`NaN` が発生することがある． 

```@repl
Inf + Inf
Inf - Inf    # ∞ - ∞
Inf * Inf    
Inf * 0      # ∞ ✕ 0
Inf / Inf    # ∞ ÷ ∞
```

不定形の極限に対応するような演算を行うと `NaN` が発生すると覚えておけばよい．

!!! danger "レポート作成上の注意"
    `Inf` や `NaN` の発生を前提としたコード設計はしないようにしてください．
    `Inf` や `NaN`の挙動を完全に把握することは非常に困難で，bug （プログラムにおける予期しない動作やエラー）
    を生みやすいです．さらに，読み手にとっても理解しにくいコードになります．ちなみにJuliaでは `isfinite(x)`や `isnan(x)`
    で `x` が `Inf` あるいは `NaN` であるかどうかの判定ができます．
    

## 情報落ち
浮動小数点数では，非常に小さい値を加えた場合（machine epsilon)，丸めによって値が変化しないことがある．
これを情報落ちという．

`1.0` に `eps(1.0) = 2.220446049250313e-16` より小さい値を加えても結果は変わらない．
例えば，
```@repl
1.0 + 1.0e-16
```
上のような例では情報落ちを回避することはできないが，
計算順序を変えることで情報落ちを回避できることがある．
```@repl
1.0e-16 + 1.0 - 1.0
1.0e-16 + (1.0 - 1.0)
```

##  桁落ち
近い値の２つの浮動小数点数を引き算すると有効桁数が減少する（桁落ち）．

例えば，$1.2345 - 1.2344 = 0.0001 = 1 \times 10^4$ は，有効桁数5桁どうしを引き算した結果，有効桁数が1桁に減っている．

したがって，浮動小数点数の計算では近い値を持つもの同士の減算はできる限り避けたほうがよい．  

## 桁落ちの例と回避法

 $b$ を正の実数とする．
2次方程式　$f(x) = x^2 - 2bx + 1 = 0$ の解は，解の公式より
```math 
  \alpha := b - \sqrt{b^2 - 1}, \quad \beta := b + \sqrt{b^2 - 1} 
```
と表される．
$b^2 \gg 1$の場合，
$\alpha$をこのまま計算すると， $\sqrt{b^2 - 1} \approx b$ であるから桁落ちが生じる．

```@repl
b = 1e8  # 1e8 = 10^8 
alpha = b - sqrt(b^2-1)
```

計算値は `0.0` であるが，これが解ではないことは代入してみれば明らかである．

このような場合でも，式変形で桁落ちを避けることができる．

```math
 b - \sqrt{b^2 - 1}  = \frac{1}{b + \sqrt{b^2 - 1}} 
```

上の式で計算してみると，
```@repl
b = 1e8
x = 1/(b + sqrt(b^2-1))
```
!!! warning
    上の$\alpha$の計算式は万能ではなく，$b<0$ かつ $b^2 \gg 1$の場合は桁落ちが発生する．
    
[](
    ```@repl
    b = -1.0e8
    x = -1/(b + sqrt(b^2-1))  # 分母の計算で桁落ちが発生 → -1/0.0
    ```
    この場合は通常の解の公式で問題なく計算できる．
    ```@repl
    b = -1.0e8
    x = -b+sqrt(b^2-c)    # 通常の解の公式
    ```
    )
!!! note
    `0.0` と `5.0e-9` は一見して大した違いがないように思われるかもしれませんが， 
    相対誤差に関してはかなり大きな開きがあります．

    桁落ちを考慮せずに素朴に計算した場合の数値解 `0.0` に対する相対誤差は
    $\dfrac{|\alpha - 0.0|}{|\alpha|} = 1.$

    一方で， 有理化して桁落ちを回避した数値解の相対誤差は，
    $2.52\times 10^{-17}$ 未満であることが示せます．

    > まず，$\epsilon = 1.26\times 10^{-25}$ とおく．
    >```math
    >\begin{aligned}
    >  f(5 \times10^{-9}) &= 25 \times 10^{-18} > 0, \\
    >  f(5 \times10^{-9} + \epsilon) 
    >  &= (5 \times10^{-9} + \epsilon)^2 -2\times 10^8 \epsilon  \\
    >  &= 2.5 \times 10^{-17} + 10^{-8} \epsilon + \epsilon^2  - 2.52 \times 10^{-17} < 0
    >\end{aligned}   
    >```
    >中間値の定理より， $\alpha \in (5\times 10^{-9}, 5\times 10^{-9}+\epsilon)$ となる．
    >よって，`5.0e-9` の絶対誤差は $|\alpha - 5\times 10^{-9}| < \epsilon = 1.26\times 10^{-25}$ と評価される．
    >`5.0e-9` の相対誤差は， $\dfrac{|\alpha - 5\times 10^{-9}|}{|\alpha|} < \dfrac{1.26\times 10^{-25}}{5\times 10^{-9}} = 2.52\times 10^{-17}$ と評価される．

